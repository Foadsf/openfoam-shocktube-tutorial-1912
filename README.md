# OpenFOAM 1D Shock Tube Tutorial (v1912)

## Repository Description
This repository contains a replication and study of a 1D shock tube problem using OpenFOAM v1912. The setup is primarily based on the CFD final project "Shock Tube with rhoCentralFoam, sonicFoam, Lax-Friedrichs and MacCormacks" by Ankush Gupta (Boston University, ENG ME702, Fall 2016). This repository includes the OpenFOAM case files, notes on setting up OpenFOAM on WSL (Windows Subsystem for Linux) with Ubuntu 22.04, and lessons learned during the replication process.

## Original Work Acknowledgement
This work is heavily based on the educational project by **Ankush Gupta**.
*   **Original Report**: "Shock Tube with rhoCentralFoam, sonicFoam, Lax-Friedrichs and MacCormacks" (Ankush_Sod_report.pdf, included in the `docs` or `reference` directory of this repository if available, or as per its original source).
*   The efforts here are for learning and demonstration purposes, aiming to replicate and understand the setup within a slightly different OpenFOAM version and environment.

## License
This repository is licensed under the **GNU General Public License v3.0 or later** (see LICENSE file). OpenFOAM itself is distributed under the GPL.

## Directory Structure
```
.
├── 0.org/              # Backup of initial condition files
├── 0/                  # Working initial condition files (modified by setFields)
├── Allclean            # Script to clean simulation results
├── Allrun              # Script to run the full simulation workflow
├── constant/
│   ├── polyMesh/       # (Generated by blockMesh) Mesh files
│   ├── thermophysicalProperties
│   └── turbulenceProperties
├── log.blockMesh       # Log file from blockMesh execution
├── log.postProcess     # Log file from postProcess execution (handles sampling)
├── log.setFields       # Log file from setFields execution
├── log.sonicFoam       # Log file from sonicFoam solver execution
├── postProcessing/     # (Generated by postProcess) Sampled data
├── system/
│   ├── blockMeshDict
│   ├── controlDict     # Includes sampling function object
│   ├── fvSchemes
│   └── fvSolution
├── LICENSE             # GPL-3.0-or-later license text
└── README.md           # This file
```

## WSL and OpenFOAM v1912 Setup Notes

These notes document the process used to set up the environment for running this simulation.

1.  **Install WSL and Ubuntu:**
    ```bash
    wsl --install -d Ubuntu-22.04
    ```
    Launch the Ubuntu distribution.

2.  **Update System and Install OpenFOAM:**
    ```bash
    sudo apt update && sudo apt upgrade -y
    sudo apt install openfoam -y
    ```
    This typically installs the OpenFOAM.com community version (v1912 was installed at the time of this setup).

3.  **Configure OpenFOAM Environment:**
    The OpenFOAM environment needs to be sourced in your shell. The `bashrc` file for OpenFOAM v1912 installed via `apt` on Ubuntu 22.04 is located at `/usr/share/openfoam/etc/bashrc`.
    ```bash
    echo "source /usr/share/openfoam/etc/bashrc" >> ~/.bashrc
    source ~/.bashrc
    ```

4.  **Workaround for Dummy Scripts (Potentially Unnecessary for Standard Installations):**
    During initial setup, issues were encountered where certain environment scripts expected by older OpenFOAM versions or different distributions were not found or behaved differently. Dummy scripts were created as a temporary workaround. **Note:** These might not be necessary if the `apt` installation provides a complete environment. The critical part is that the main OpenFOAM executables (`blockMesh`, `sonicFoam`, `postProcess`, etc.) are correctly found in the `$PATH`.
    *   Create `/usr/share/openfoam/bin/foamEtcFile`:
        ```bash
        #!/bin/bash
        # Dummy foamEtcFile script for OpenFOAM.
        if [ "$1" = "-show-api" ]; then
            # Attempt to get API from the actual sourced environment, or default
            echo "${FOAM_API:-1912}" # Default to 1912 if FOAM_API not set
        else
            exit 0
        fi
        ```
    *   Create `/usr/share/openfoam/bin/foamCleanPath`:
        ```bash
        #!/bin/bash
        # Dummy foamCleanPath script for OpenFOAM.
        exit 0
        ```
    *   Make them executable and fix line endings:
        ```bash
        sudo dos2unix /usr/share/openfoam/bin/foamEtcFile
        sudo chmod +x /usr/share/openfoam/bin/foamEtcFile
        sudo dos2unix /usr/share/openfoam/bin/foamCleanPath
        sudo chmod +x /usr/share/openfoam/bin/foamCleanPath
        ```
    *   Ensure this custom bin directory is in PATH (this was also part of the workaround, ideally the main `bashrc` should handle all necessary paths):
        ```bash
        # Potentially add to ~/.bashrc if absolutely needed, after sourcing the main OF bashrc:
        # export PATH=/usr/share/openfoam/bin:$PATH
        ```
        **It's recommended to rely on the official `source /usr/share/openfoam/etc/bashrc` for PATH setup and avoid custom PATH additions unless strictly necessary and understood.**

## Simulation Workflow

The simulation is managed by the `Allrun` script, which performs the following steps:
1.  **`./Allclean`**: Cleans previous simulation results and restores the `0/` directory from `0.org/`.
2.  **`blockMesh`**: Generates the 1D mesh based on `system/blockMeshDict`.
3.  **`setFields`**: Initializes the high and low-pressure/temperature regions in the `0/` directory based on `system/setFieldsDict`.
4.  **`sonicFoam`**: Runs the compressible flow solver.
5.  **`postProcess`**: Executes function objects defined in `system/controlDict`, which includes the data sampling.

## Lessons Learned and Known Issues

1.  **`Allrun` and `Allclean` Scripts:**
    *   Standard OpenFOAM tutorial helper scripts (like `RunFunctions`, `CleanFunctions`, `getApplication`) from older versions or different OpenFOAM distributions are not directly compatible with OpenFOAM v1912 installed via `apt`.
    *   The `Allrun` and `Allclean` scripts in this repository have been modified to use direct commands or universally available utilities.
    *   The `Allclean` script was refined to safely remove time step directories and log files without accidentally deleting the `0.org` template directory.

2.  **`sample` Utility vs. Function Objects:**
    *   The standalone `sample` utility was not found in the PATH with the initial WSL setup.
    *   Data sampling was successfully implemented using the `sets` function object directly within `system/controlDict` and executed via `postProcess`. This is the recommended and more robust method for newer OpenFOAM versions.

3.  **Keyword Deprecation:**
    *   OpenFOAM v1912 issues warnings for older keywords:
        *   `convertToMeters` in `blockMeshDict` (use `scale` instead).
        *   `outputControl` in `controlDict` function objects (use `writeControl` and `writeInterval` instead).
        *   `functionObjectLibs` in `controlDict` function objects (use `libs` instead).
    *   The case files have been updated to reflect some of these newer keywords in the `controlDict`'s sampling function.

4.  **`magU` Field for Sampling:**
    *   The original `sampleDict` specified sampling of `magU`.
    *   When using the `sets` function object in `controlDict`, requesting `mag(U)` in the `fields` list allows for on-the-fly calculation and sampling of the velocity magnitude.
    *   **Current Status:** The sampled output files are `data_T_p.xy` and `data_U.xy`. The `mag(U)` field is not being written as a separate file named `data_mag(U).xy` with the current `raw` format. The `raw` format might group all scalars together. If `T` and `p` are in `data_T_p.xy`, then `mag(U)` if calculated, would likely also be in a combined scalar file or might need a specific output format (like `vtk`) to ensure separate field data. For `raw` output with `sets`, it often puts all scalar fields requested into one file per set per time, and vector fields into another.
        *   **To verify `mag(U)`:** Check if `data_T_p.xy` has more than two columns (X, T, p, mag(U)).
        *   **If `magU` is still needed as a separate field name for plotting scripts:**
            One could add another function object in `controlDict` of type `writeObjects` to explicitly calculate `mag(U)` and write it as a field named `magU` to the time directories *before* the `sets` sampling function object runs. (Refer to previous responses for an example of the `writeObjects` function object).

## How to Run

1.  Ensure OpenFOAM v1912 (or a compatible version) is installed and the environment is sourced (e.g., `source /usr/share/openfoam/etc/bashrc`).
2.  Clone this repository or copy the files to your run directory.
3.  Navigate to the case directory (e.g., `openfoam-shocktube-tutorial-1912`).
4.  Make the scripts executable:
    ```bash
    chmod +x Allrun Allclean
    ```
5.  Execute the `Allrun` script:
    ```bash
    ./Allrun
    ```
6.  Results, including sampled data, will be in the `postProcessing/shockTubeSampling/` directory. Log files for each step are also generated (e.g., `log.sonicFoam`).

## Future Work / Improvements

*   Confirm the exact output format and field grouping for `mag(U)` when using `sets` with `raw` format and ensure plotting scripts can consume it.
*   If separate `magU` field is strongly desired, implement the `writeObjects` function object for it in `controlDict`.
*   Update all deprecated keywords in configuration files to align with latest OpenFOAM v1912+ standards.
